---
title: å“²å­¦å®¶å°±é¤é—®é¢˜
date: 2025-11-04
categories: [æ“ä½œç³»ç»Ÿ,åŸºæœ¬æ¦‚å¿µ]
---

# å“²å­¦å®¶å°±é¤é—®é¢˜ (Dining Philosophers Problem)

## 1. é—®é¢˜æ¦‚è¿°

å“²å­¦å®¶å°±é¤é—®é¢˜æ˜¯ä¸€ä¸ªç»å…¸çš„**å¹¶å‘æ§åˆ¶é—®é¢˜**ï¼Œç”±è·å…°è®¡ç®—æœºç§‘å­¦å®¶Edsger W. Dijkstraäº1965å¹´æå‡ºã€‚è¿™ä¸ªé—®é¢˜ç”¨äºæ¼”ç¤º**å¦‚ä½•é¿å…æ­»é”å’Œèµ„æºäº‰ç”¨**çš„å¹¶å‘ç³»ç»Ÿè®¾è®¡æŒ‘æˆ˜ã€‚

é—®é¢˜æè¿°ï¼š
- æœ‰5ä½å“²å­¦å®¶å›´ååœ¨ä¸€å¼ åœ†æ¡Œæ—
- æ¯ä½å“²å­¦å®¶ä¹‹é—´æœ‰ä¸€æŠŠå‰å­ï¼ˆå…±5æŠŠå‰å­ï¼‰
- å“²å­¦å®¶çš„ç”Ÿæ´»åªæœ‰ä¸¤ç§çŠ¶æ€ï¼šæ€è€ƒå’Œåƒé¥­
- å“²å­¦å®¶éœ€è¦åŒæ—¶æ‹¿èµ·å·¦å³ä¸¤è¾¹çš„å‰å­æ‰èƒ½åƒé¥­
- åƒå®Œé¥­åï¼Œå“²å­¦å®¶ä¼šæ”¾ä¸‹å‰å­ï¼Œç»§ç»­æ€è€ƒ

## 2. é—®é¢˜æ¨¡å‹

### 2.1 åŸºæœ¬è¦ç´ 

1. **å“²å­¦å®¶**ï¼šå¹¶å‘æ‰§è¡Œçš„è¿›ç¨‹æˆ–çº¿ç¨‹
2. **å‰å­**ï¼šå…±äº«èµ„æºï¼Œä»£è¡¨ä¸´ç•ŒåŒºæˆ–é”
3. **çŠ¶æ€è½¬æ¢**ï¼š
   - æ€è€ƒ â†’ é¥¿äº† â†’ å°è¯•è·å–å‰å­ â†’ åƒé¥­ â†’ æ”¾ä¸‹å‰å­ â†’ æ€è€ƒ

### 2.2 å›¾ç¤ºæ¨¡å‹

@startuml
title äº”ä¸ªå“²å­¦å®¶å›´ååœ†æ¡Œç¤ºæ„å›¾

' ç¯å½¢å¸ƒå±€
left to right direction

' å®šä¹‰å“²å­¦å®¶ï¼ˆåœ†å½¢ï¼‰
circle "å“²å­¦å®¶0" as P0
circle "å“²å­¦å®¶1" as P1
circle "å“²å­¦å®¶2" as P2
circle "å“²å­¦å®¶3" as P3
circle "å“²å­¦å®¶4" as P4

' å®šä¹‰å‰å­ï¼ˆæ–¹æ¡†ï¼‰
rectangle "å‰å­0" as F0
rectangle "å‰å­1" as F1
rectangle "å‰å­2" as F2
rectangle "å‰å­3" as F3
rectangle "å‰å­4" as F4

' ç¯å½¢å…³ç³»ï¼ˆå“²å­¦å®¶ä¸å·¦å³å‰å­ï¼‰
P0 -- F0
F0 -- P4
P4 -- F4
F4 -- P3
P3 -- F3
F3 -- P2
P2 -- F2
F2 -- P1
P1 -- F1
F1 -- P0

' å›¾ä¾‹
legend left
ğŸ¥¢ äº”ä¸ªå“²å­¦å®¶å›´ååœ†æ¡Œ
æ¯ä½å“²å­¦å®¶å·¦å³å„æœ‰ä¸€æŠŠå‰å­
å½¢æˆä¸€ä¸ªé—­ç¯ç»“æ„
endlegend
@enduml


### 2.3 é—®é¢˜æœ¬è´¨

å“²å­¦å®¶å°±é¤é—®é¢˜æœ¬è´¨ä¸Šæ˜¯**èµ„æºåˆ†é…é—®é¢˜**å’Œ**è¿›ç¨‹åŒæ­¥é—®é¢˜**çš„ç»“åˆï¼š
- æ¯ä¸ªå“²å­¦å®¶éœ€è¦ä¸¤ä¸ªèµ„æºï¼ˆä¸¤æŠŠå‰å­ï¼‰æ‰èƒ½ç»§ç»­æ‰§è¡Œ
- èµ„æºè·å–é¡ºåºä¸å½“å¯èƒ½å¯¼è‡´æ­»é”
- ç¼ºä¹é€‚å½“çš„åŒæ­¥æœºåˆ¶ä¼šå¯¼è‡´èµ„æºäº‰ç”¨å’Œé¥¥é¥¿

## 3. æ­»é”é£é™©

å¦‚æœæ¯ä½å“²å­¦å®¶åŒæ—¶æ‹¿èµ·å·¦è¾¹çš„å‰å­ï¼Œç„¶åéƒ½è¯•å›¾æ‹¿èµ·å³è¾¹çš„å‰å­ï¼Œå°±ä¼šå‘ç”Ÿæ­»é”ï¼š

```
å“²å­¦å®¶0æ‹¿èµ·å‰å­0ï¼Œç­‰å¾…å‰å­1
å“²å­¦å®¶1æ‹¿èµ·å‰å­1ï¼Œç­‰å¾…å‰å­0
å“²å­¦å®¶2æ‹¿èµ·å‰å­2ï¼Œç­‰å¾…å‰å­3
å“²å­¦å®¶3æ‹¿èµ·å‰å­3ï¼Œç­‰å¾…å‰å­4
å“²å­¦å®¶4æ‹¿èµ·å‰å­4ï¼Œç­‰å¾…å‰å­0
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å“²å­¦å®¶éƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾å‰å­ï¼Œå½¢æˆå¾ªç¯ç­‰å¾…ï¼Œå¯¼è‡´æ­»é”ã€‚

## 4. è§£å†³æ–¹æ¡ˆ

### 4.1 è§£å†³æ–¹æ¡ˆä¸€ï¼šæœ€å¤šå…è®¸4ä½å“²å­¦å®¶åŒæ—¶å°±é¤

#### æ€è·¯
é™åˆ¶åŒæ—¶æ‹¿èµ·å‰å­çš„å“²å­¦å®¶æ•°é‡ï¼Œç¡®ä¿è‡³å°‘æœ‰ä¸€ä½å“²å­¦å®¶èƒ½å¤Ÿå®Œæˆç”¨é¤å¹¶é‡Šæ”¾èµ„æºã€‚

#### å®ç°åŸç†
- ä½¿ç”¨ä¸€ä¸ªè®¡æ•°å™¨è®°å½•å½“å‰æ­£åœ¨å°è¯•è·å–å‰å­çš„å“²å­¦å®¶æ•°é‡
- å½“è®¡æ•°å™¨è¾¾åˆ°4æ—¶ï¼Œç¬¬5ä½å“²å­¦å®¶å¿…é¡»ç­‰å¾…
- è¿™æ ·è‡³å°‘æœ‰ä¸€ä½å“²å­¦å®¶èƒ½å¤Ÿè·å¾—å·¦å³ä¸¤æŠŠå‰å­ï¼Œåƒå®Œåé‡Šæ”¾èµ„æº

#### Javaå®ç°

```java
import java.util.concurrent.Semaphore;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.Random;

public class DiningPhilosophersWithLimit {
    private static final int NUM_PHILOSOPHERS = 5;
    private final Lock[] forks = new Lock[NUM_PHILOSOPHERS]; // å‰å­é”
    private final Semaphore maxDiners; // é™åˆ¶åŒæ—¶å°±é¤çš„å“²å­¦å®¶æ•°é‡
    private final Random random = new Random();
    
    public DiningPhilosophersWithLimit() {
        // åˆå§‹åŒ–å‰å­é”
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            forks[i] = new ReentrantLock();
        }
        // æœ€å¤šå…è®¸4ä¸ªå“²å­¦å®¶åŒæ—¶å°è¯•è·å–å‰å­
        maxDiners = new Semaphore(4);
    }
    
    // å“²å­¦å®¶è¡Œä¸º
    private void philosopher(int id) throws InterruptedException {
        while (true) {
            think(id);
            eat(id);
        }
    }
    
    // æ€è€ƒ
    private void think(int id) throws InterruptedException {
        System.out.println("å“²å­¦å®¶ " + id + " æ­£åœ¨æ€è€ƒ");
        TimeUnit.MILLISECONDS.sleep(random.nextInt(1000));
    }
    
    // åƒé¥­
    private void eat(int id) throws InterruptedException {
        // å°è¯•è·å–è®¸å¯ï¼Œé™åˆ¶åŒæ—¶å°±é¤çš„å“²å­¦å®¶æ•°é‡
        maxDiners.acquire();
        
        try {
            // è·å–å·¦å³å‰å­ï¼ˆç¼–å·è¾ƒå°çš„å‰å­ä¼˜å…ˆï¼‰
            int leftFork = id;
            int rightFork = (id + 1) % NUM_PHILOSOPHERS;
            
            // æ€»æ˜¯å…ˆæ‹¿ç¼–å·è¾ƒå°çš„å‰å­
            if (leftFork > rightFork) {
                int temp = leftFork;
                leftFork = rightFork;
                rightFork = temp;
            }
            
            // è·å–å·¦è¾¹å‰å­
            forks[leftFork].lock();
            System.out.println("å“²å­¦å®¶ " + id + " æ‹¿èµ·äº†å‰å­ " + leftFork);
            
            // è·å–å³è¾¹å‰å­
            forks[rightFork].lock();
            System.out.println("å“²å­¦å®¶ " + id + " æ‹¿èµ·äº†å‰å­ " + rightFork);
            
            // åƒé¥­
            System.out.println("å“²å­¦å®¶ " + id + " æ­£åœ¨åƒé¥­");
            TimeUnit.MILLISECONDS.sleep(random.nextInt(1000));
            
        } finally {
            // æ”¾ä¸‹å‰å­
            int leftFork = id;
            int rightFork = (id + 1) % NUM_PHILOSOPHERS;
            
            forks[leftFork].unlock();
            forks[rightFork].unlock();
            
            System.out.println("å“²å­¦å®¶ " + id + " æ”¾ä¸‹äº†å‰å­ " + leftFork + " å’Œ " + rightFork);
            
            // é‡Šæ”¾è®¸å¯
            maxDiners.release();
        }
    }
    
    public static void main(String[] args) {
        DiningPhilosophersWithLimit dining = new DiningPhilosophersWithLimit();
        
        // åˆ›å»ºå¹¶å¯åŠ¨å“²å­¦å®¶çº¿ç¨‹
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            final int id = i;
            Thread thread = new Thread(() -> {
                try {
                    dining.philosopher(id);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
            thread.start();
        }
    }
}
```

### 4.2 è§£å†³æ–¹æ¡ˆäºŒï¼šèµ„æºåˆ†çº§è·å–

#### æ€è·¯
é€šè¿‡è§„å®šå“²å­¦å®¶è·å–å‰å­çš„é¡ºåºï¼Œé¿å…å¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚

#### å®ç°åŸç†

é€šè¿‡ä¸ºå‰å­ç¼–å·å¹¶è§„å®šå“²å­¦å®¶å¿…é¡»æŒ‰ç¼–å·é¡ºåºè·å–èµ„æºï¼ˆå…ˆå°åå¤§ï¼‰ï¼Œæ‰“ç ´äº†å¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚è¿™ç§æ–¹æ³•ç¡®ä¿ä¸ä¼šæ‰€æœ‰å“²å­¦å®¶åŒæ—¶æŒæœ‰ä½ç¼–å·å‰å­å¹¶ç­‰å¾…é«˜ç¼–å·å‰å­ï¼Œä»è€Œé¿å…æ­»é”ã€‚

**ä¸å­˜åœ¨"äº’ç›¸ç­‰å¾…å¯¹æ–¹å‰å­"çš„å¾ªç¯**

å‡è®¾æ‰€æœ‰å“²å­¦å®¶åŒæ—¶æƒ³åƒé¥­ï¼Œéƒ½ä¼šå…ˆå°è¯•æ‹¿"ç¼–å·å°çš„å‰å­"ï¼š
- å“²å­¦å®¶0ã€1ã€2ã€3ä¼šå…ˆæ‹¿0ã€1ã€2ã€3å·å‰å­ï¼ˆå„è‡ªçš„å·¦å‰ï¼Œä¸”æ˜¯å°ç¼–å·ï¼‰
- å“²å­¦å®¶4ä¼šå…ˆæ‹¿0å·å‰å­ï¼ˆå› ä¸ºä»–çš„å³å‰æ˜¯0ï¼Œæ¯”å·¦å‰4å°ï¼‰

æ­¤æ—¶åªä¼šå‡ºç°"ç«äº‰åŒä¸€æŠŠå°ç¼–å·å‰å­"çš„æƒ…å†µï¼ˆæ¯”å¦‚0å·å’Œ4å·å“²å­¦å®¶éƒ½æŠ¢0å·å‰å­ï¼‰ï¼Œä½†æŠ¢åˆ°çš„äººæ‰èƒ½ç»§ç»­æ‹¿ç¬¬äºŒæŠŠï¼Œæ²¡æŠ¢åˆ°çš„äººä¼šé˜»å¡ï¼Œä¸ä¼šå½¢æˆ"ä½ ç­‰æˆ‘ã€æˆ‘ç­‰ä½ "çš„å¾ªç¯ã€‚

#### Javaå®ç°

```java
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.Random;

public class DiningPhilosophersWithOrderedResources {
    private static final int NUM_PHILOSOPHERS = 5;
    private final Lock[] forks = new Lock[NUM_PHILOSOPHERS];
    private final Random random = new Random();
    
    public DiningPhilosophersWithOrderedResources() {
        // åˆå§‹åŒ–å‰å­é”
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            forks[i] = new ReentrantLock();
        }
    }
    
    // å“²å­¦å®¶è¡Œä¸º
    private void philosopher(int id) throws InterruptedException {
        while (true) {
            think(id);
            eat(id);
        }
    }
    
    // æ€è€ƒ
    private void think(int id) throws InterruptedException {
        System.out.println("å“²å­¦å®¶ " + id + " æ­£åœ¨æ€è€ƒ");
        TimeUnit.MILLISECONDS.sleep(random.nextInt(1000));
    }
    
    // åƒé¥­
    private void eat(int id) throws InterruptedException {
        // ç¡®å®šå·¦å³å‰å­ç¼–å·
        int leftFork = id;
        int rightFork = (id + 1) % NUM_PHILOSOPHERS;
        
        // å…³é”®ï¼šæ€»æ˜¯å…ˆè·å–ç¼–å·è¾ƒå°çš„å‰å­
        int firstFork = Math.min(leftFork, rightFork);
        int secondFork = Math.max(leftFork, rightFork);
        
        // å°è¯•è·å–ç¬¬ä¸€æŠŠå‰å­
        forks[firstFork].lock();
        System.out.println("å“²å­¦å®¶ " + id + " æ‹¿èµ·äº†å‰å­ " + firstFork);
        
        try {
            // å°è¯•è·å–ç¬¬äºŒæŠŠå‰å­
            forks[secondFork].lock();
            System.out.println("å“²å­¦å®¶ " + id + " æ‹¿èµ·äº†å‰å­ " + secondFork);
            
            // åƒé¥­
            System.out.println("å“²å­¦å®¶ " + id + " æ­£åœ¨åƒé¥­");
            TimeUnit.MILLISECONDS.sleep(random.nextInt(1000));
            
        } finally {
            // é‡Šæ”¾å‰å­ï¼Œé¡ºåºæ— å…³ç´§è¦
            forks[secondFork].unlock();
            forks[firstFork].unlock();
            System.out.println("å“²å­¦å®¶ " + id + " æ”¾ä¸‹äº†å‰å­ " + firstFork + " å’Œ " + secondFork);
        }
    }
    
    public static void main(String[] args) {
        DiningPhilosophersWithOrderedResources dining = new DiningPhilosophersWithOrderedResources();
        
        // åˆ›å»ºå¹¶å¯åŠ¨å“²å­¦å®¶çº¿ç¨‹
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            final int id = i;
            Thread thread = new Thread(() -> {
                try {
                    dining.philosopher(id);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
            thread.start();
        }
    }
}
```

### 4.3 è§£å†³æ–¹æ¡ˆä¸‰ï¼šä¿¡å·é‡å®ç°

#### æ€è·¯
ä½¿ç”¨ä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ¥æ§åˆ¶èµ„æºè®¿é—®ï¼Œç»“åˆäº’æ–¥é”ç¡®ä¿åŸå­æ“ä½œã€‚

#### å®ç°åŸç†
- ä½¿ç”¨ä¸€ä¸ªä¿¡å·é‡è¡¨ç¤ºä¸€æŠŠå‰å­
- ä½¿ç”¨äº’æ–¥é”ç¡®ä¿å“²å­¦å®¶è·å–ä¸¤æŠŠå‰å­çš„æ“ä½œæ˜¯åŸå­çš„
- æˆ–è€…è®©ä¸€ä½å“²å­¦å®¶ä¸å…¶ä»–å“²å­¦å®¶è·å–å‰å­çš„é¡ºåºç›¸å

#### Javaå®ç°

```java
import java.util.concurrent.Semaphore;
import java.util.concurrent.TimeUnit;
import java.util.Random;

public class DiningPhilosophersWithSemaphores {
    private static final int NUM_PHILOSOPHERS = 5;
    private final Semaphore[] forks = new Semaphore[NUM_PHILOSOPHERS];
    private final Random random = new Random();
    
    public DiningPhilosophersWithSemaphores() {
        // åˆå§‹åŒ–å‰å­ä¿¡å·é‡ï¼Œæ¯ä¸ªä¿¡å·é‡åˆå§‹åŒ–ä¸º1ï¼ˆè¡¨ç¤ºèµ„æºå¯ç”¨ï¼‰
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            forks[i] = new Semaphore(1);
        }
    }
    
    // å“²å­¦å®¶è¡Œä¸º
    private void philosopher(int id) throws InterruptedException {
        while (true) {
            think(id);
            eat(id);
        }
    }
    
    // æ€è€ƒ
    private void think(int id) throws InterruptedException {
        System.out.println("å“²å­¦å®¶ " + id + " æ­£åœ¨æ€è€ƒ");
        TimeUnit.MILLISECONDS.sleep(random.nextInt(1000));
    }
    
    // åƒé¥­ - å¯¹æœ€åä¸€ä½å“²å­¦å®¶ç‰¹æ®Šå¤„ç†ï¼Œåè½¬è·å–å‰å­çš„é¡ºåº
    private void eat(int id) throws InterruptedException {
        int leftFork = id;
        int rightFork = (id + 1) % NUM_PHILOSOPHERS;
        
        // æœ€åä¸€ä½å“²å­¦å®¶å…ˆæ‹¿å³è¾¹çš„å‰å­ï¼Œæ‰“ç ´å¾ªç¯ä¾èµ–
        if (id == NUM_PHILOSOPHERS - 1) {
            // è·å–å³è¾¹å‰å­
            forks[rightFork].acquire();
            System.out.println("å“²å­¦å®¶ " + id + " æ‹¿èµ·äº†å‰å­ " + rightFork);
            
            // è·å–å·¦è¾¹å‰å­
            forks[leftFork].acquire();
            System.out.println("å“²å­¦å®¶ " + id + " æ‹¿èµ·äº†å‰å­ " + leftFork);
        } else {
            // å…¶ä»–å“²å­¦å®¶å…ˆæ‹¿å·¦è¾¹çš„å‰å­
            forks[leftFork].acquire();
            System.out.println("å“²å­¦å®¶ " + id + " æ‹¿èµ·äº†å‰å­ " + leftFork);
            
            forks[rightFork].acquire();
            System.out.println("å“²å­¦å®¶ " + id + " æ‹¿èµ·äº†å‰å­ " + rightFork);
        }
        
        try {
            // åƒé¥­
            System.out.println("å“²å­¦å®¶ " + id + " æ­£åœ¨åƒé¥­");
            TimeUnit.MILLISECONDS.sleep(random.nextInt(1000));
            
        } finally {
            // é‡Šæ”¾å‰å­
            forks[leftFork].release();
            forks[rightFork].release();
            System.out.println("å“²å­¦å®¶ " + id + " æ”¾ä¸‹äº†å‰å­ " + leftFork + " å’Œ " + rightFork);
        }
    }
    
    public static void main(String[] args) {
        DiningPhilosophersWithSemaphores dining = new DiningPhilosophersWithSemaphores();
        
        // åˆ›å»ºå¹¶å¯åŠ¨å“²å­¦å®¶çº¿ç¨‹
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            final int id = i;
            Thread thread = new Thread(() -> {
                try {
                    dining.philosopher(id);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
            thread.start();
        }
    }
}
```

### 4.4 è§£å†³æ–¹æ¡ˆå››ï¼šä½¿ç”¨Conditionå®ç°é¥¥é¥¿é¿å…

#### æ€è·¯
ä½¿ç”¨æ˜¾å¼é”ï¼ˆLockï¼‰å’Œæ¡ä»¶å˜é‡ï¼ˆConditionï¼‰å®ç°æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œé¿å…é¥¥é¥¿é—®é¢˜ã€‚

#### å®ç°åŸç†
- è·Ÿè¸ªæ¯ä¸ªå“²å­¦å®¶å’Œå‰å­çš„çŠ¶æ€
- ä½¿ç”¨æ¡ä»¶å˜é‡è®©å“²å­¦å®¶åœ¨æ— æ³•è·å–å‰å­æ—¶ç­‰å¾…
- å®ç°å…¬å¹³çš„èµ„æºåˆ†é…ç­–ç•¥

#### Javaå®ç°

```java
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.Random;

public class DiningPhilosophersWithConditions {
    private static final int NUM_PHILOSOPHERS = 5;
    
    // å“²å­¦å®¶çŠ¶æ€æšä¸¾
    private enum State {
        THINKING, HUNGRY, EATING
    }
    
    private final State[] states = new State[NUM_PHILOSOPHERS]; // å“²å­¦å®¶çŠ¶æ€
    private final Lock lock = new ReentrantLock(); // å…¨å±€é”
    private final Condition[] self = new Condition[NUM_PHILOSOPHERS]; // æ¯ä¸ªå“²å­¦å®¶çš„æ¡ä»¶å˜é‡
    private final Random random = new Random();
    
    public DiningPhilosophersWithConditions() {
        // åˆå§‹åŒ–æ‰€æœ‰å“²å­¦å®¶ä¸ºæ€è€ƒçŠ¶æ€
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            states[i] = State.THINKING;
            self[i] = lock.newCondition();
        }
    }
    
    // æ£€æŸ¥å“²å­¦å®¶æ˜¯å¦å¯ä»¥å¼€å§‹åƒé¥­
    private void test(int id) {
        // å¦‚æœå½“å‰å“²å­¦å®¶é¥¥é¥¿ï¼Œä¸”å·¦å³é‚»å±…éƒ½ä¸åœ¨åƒé¥­ï¼Œåˆ™å¯ä»¥å¼€å§‹åƒé¥­
        if (states[id] == State.HUNGRY &&
            states[(id + NUM_PHILOSOPHERS - 1) % NUM_PHILOSOPHERS] != State.EATING &&
            states[(id + 1) % NUM_PHILOSOPHERS] != State.EATING) {
            
            states[id] = State.EATING;
            self[id].signal(); // å”¤é†’ç­‰å¾…çš„å“²å­¦å®¶
        }
    }
    
    // è·å–å‰å­
    private void takeForks(int id) throws InterruptedException {
        lock.lock();
        try {
            states[id] = State.HUNGRY;
            System.out.println("å“²å­¦å®¶ " + id + " é¥¿äº†ï¼Œæ­£åœ¨ç­‰å¾…å‰å­");
            test(id); // å°è¯•è·å–å‰å­
            
            if (states[id] != State.EATING) {
                self[id].await(); // å¦‚æœæ— æ³•è·å–å‰å­ï¼Œåˆ™ç­‰å¾…
            }
            
            System.out.println("å“²å­¦å®¶ " + id + " è·å¾—äº†ä¸¤æŠŠå‰å­ï¼Œå¯ä»¥å¼€å§‹åƒé¥­");
        } finally {
            lock.unlock();
        }
    }
    
    // æ”¾ä¸‹å‰å­
    private void putForks(int id) {
        lock.lock();
        try {
            states[id] = State.THINKING;
            System.out.println("å“²å­¦å®¶ " + id + " æ”¾ä¸‹äº†å‰å­ï¼Œç»§ç»­æ€è€ƒ");
            
            // æµ‹è¯•å·¦å³é‚»å±…æ˜¯å¦å¯ä»¥å¼€å§‹åƒé¥­
            test((id + NUM_PHILOSOPHERS - 1) % NUM_PHILOSOPHERS);
            test((id + 1) % NUM_PHILOSOPHERS);
        } finally {
            lock.unlock();
        }
    }
    
    // å“²å­¦å®¶è¡Œä¸º
    private void philosopher(int id) throws InterruptedException {
        while (true) {
            think(id);
            takeForks(id);
            eat(id);
            putForks(id);
        }
    }
    
    // æ€è€ƒ
    private void think(int id) throws InterruptedException {
        System.out.println("å“²å­¦å®¶ " + id + " æ­£åœ¨æ€è€ƒ");
        TimeUnit.MILLISECONDS.sleep(random.nextInt(1000));
    }
    
    // åƒé¥­
    private void eat(int id) throws InterruptedException {
        System.out.println("å“²å­¦å®¶ " + id + " æ­£åœ¨åƒé¥­");
        TimeUnit.MILLISECONDS.sleep(random.nextInt(1000));
    }
    
    public static void main(String[] args) {
        DiningPhilosophersWithConditions dining = new DiningPhilosophersWithConditions();
        
        // åˆ›å»ºå¹¶å¯åŠ¨å“²å­¦å®¶çº¿ç¨‹
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            final int id = i;
            Thread thread = new Thread(() -> {
                try {
                    dining.philosopher(id);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
            thread.start();
        }
    }
}
```

## 5. å„ç§è§£å†³æ–¹æ¡ˆçš„æ¯”è¾ƒ

| è§£å†³æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|----------|
| é™åˆ¶åŒæ—¶å°±é¤äººæ•° | å®ç°ç®€å•ï¼Œæ•ˆæœå¥½ | èµ„æºåˆ©ç”¨ç‡ä¸é«˜ | èµ„æºç«äº‰ä¸æ¿€çƒˆçš„åœºæ™¯ |
| èµ„æºåˆ†çº§è·å– | é¿å…æ­»é”ï¼Œå®ç°ç®€å• | æŸäº›å“²å­¦å®¶å¯èƒ½ç­‰å¾…æ—¶é—´è¾ƒé•¿ | éœ€è¦é¿å…æ­»é”çš„åœºæ™¯ |
| ä¿¡å·é‡å®ç° | çµæ´»æ€§é«˜ï¼Œæ˜“äºæ‰©å±• | éœ€è¦é¢å¤–çš„åŒæ­¥æœºåˆ¶ | å¤æ‚çš„å¹¶å‘æ§åˆ¶åœºæ™¯ |
| æ¡ä»¶å˜é‡å®ç° | é¿å…é¥¥é¥¿ï¼Œå…¬å¹³æ€§å¥½ | å®ç°å¤æ‚ | å¯¹å…¬å¹³æ€§è¦æ±‚é«˜çš„åœºæ™¯ |

## 6. é«˜çº§å®ç°ï¼šå¸¦ä¼˜å…ˆçº§å’Œé¥¥é¥¿æ£€æµ‹çš„å“²å­¦å®¶å°±é¤é—®é¢˜

ä¸‹é¢æ˜¯ä¸€ä¸ªæ›´é«˜çº§çš„å®ç°ï¼ŒåŒ…å«å“²å­¦å®¶ä¼˜å…ˆçº§ã€é¥¥é¥¿æ£€æµ‹å’Œèµ„æºåˆ†é…ä¼˜åŒ–ï¼š

```java
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.Random;
import java.util.PriorityQueue;
import java.util.Comparator;

public class AdvancedDiningPhilosophers {
    private static final int NUM_PHILOSOPHERS = 5;
    private static final int HUNGER_THRESHOLD = 3000; // é¥¥é¥¿é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
    
    // å“²å­¦å®¶çŠ¶æ€æšä¸¾
    private enum State {
        THINKING, HUNGRY, EATING
    }
    
    // å“²å­¦å®¶ç±»
    private class Philosopher implements Comparable<Philosopher> {
        private final int id;
        private State state;
        private long hungerStartTime; // å¼€å§‹é¥¥é¥¿çš„æ—¶é—´
        private int priority; // ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
        private final Condition condition;
        private int eatCount; // åƒé¥­æ¬¡æ•°
        
        public Philosopher(int id) {
            this.id = id;
            this.state = State.THINKING;
            this.priority = id; // åˆå§‹ä¼˜å…ˆçº§åŸºäºID
            this.condition = lock.newCondition();
            this.eatCount = 0;
        }
        
        @Override
        public int compareTo(Philosopher other) {
            // ä¼˜å…ˆçº§æ¯”è¾ƒ
            return Integer.compare(this.priority, other.priority);
        }
        
        @Override
        public String toString() {
            return "å“²å­¦å®¶" + id + "[çŠ¶æ€:" + state + ",ä¼˜å…ˆçº§:" + priority + ",åƒé¥­æ¬¡æ•°:" + eatCount + "]";
        }
    }
    
    private final Philosopher[] philosophers = new Philosopher[NUM_PHILOSOPHERS];
    private final Lock lock = new ReentrantLock();
    private final Random random = new Random();
    private final PriorityQueue<Philosopher> hungryQueue = new PriorityQueue<>();
    private final AtomicInteger systemTime = new AtomicInteger(0); // æ¨¡æ‹Ÿç³»ç»Ÿæ—¶é—´
    
    public AdvancedDiningPhilosophers() {
        // åˆå§‹åŒ–å“²å­¦å®¶
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            philosophers[i] = new Philosopher(i);
        }
        
        // å¯åŠ¨é¥¥é¥¿æ£€æµ‹çº¿ç¨‹
        Thread hungerDetector = new Thread(this::detectHunger);
        hungerDetector.setDaemon(true);
        hungerDetector.start();
        
        // å¯åŠ¨ç³»ç»Ÿæ—¶é—´æ¨¡æ‹Ÿçº¿ç¨‹
        Thread timeSimulator = new Thread(() -> {
            while (true) {
                try {
                    TimeUnit.MILLISECONDS.sleep(100);
                    systemTime.incrementAndGet();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        });
        timeSimulator.setDaemon(true);
        timeSimulator.start();
    }
    
    // é¥¥é¥¿æ£€æµ‹
    private void detectHunger() {
        while (true) {
            try {
                TimeUnit.MILLISECONDS.sleep(500);
                lock.lock();
                
                long currentTime = systemTime.get();
                for (Philosopher p : philosophers) {
                    if (p.state == State.HUNGRY) {
                        long hungerTime = currentTime - p.hungerStartTime;
                        if (hungerTime > HUNGER_THRESHOLD) {
                            // æé«˜é¥¥é¥¿å“²å­¦å®¶çš„ä¼˜å…ˆçº§
                            p.priority = Math.max(0, p.priority - 1);
                            System.out.println("è­¦å‘Š: " + p + " å·²ç»é¥¥é¥¿ " + hungerTime + " æ¯«ç§’ï¼Œæé«˜ä¼˜å…ˆçº§åˆ° " + p.priority);
                            
                            // é‡æ–°æ’åºé¥¥é¥¿é˜Ÿåˆ—
                            rebuildHungryQueue();
                            
                            // å°è¯•å”¤é†’é¥¥é¥¿çš„å“²å­¦å®¶
                            for (Philosopher philosopher : philosophers) {
                                test(philosopher.id);
                            }
                        }
                    }
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            } finally {
                lock.unlock();
            }
        }
    }
    
    // é‡å»ºé¥¥é¥¿é˜Ÿåˆ—
    private void rebuildHungryQueue() {
        hungryQueue.clear();
        for (Philosopher p : philosophers) {
            if (p.state == State.HUNGRY) {
                hungryQueue.offer(p);
            }
        }
    }
    
    // æµ‹è¯•å“²å­¦å®¶æ˜¯å¦å¯ä»¥åƒé¥­
    private boolean test(int id) {
        Philosopher p = philosophers[id];
        Philosopher left = philosophers[(id + NUM_PHILOSOPHERS - 1) % NUM_PHILOSOPHERS];
        Philosopher right = philosophers[(id + 1) % NUM_PHILOSOPHERS];
        
        if (p.state == State.HUNGRY && left.state != State.EATING && right.state != State.EATING) {
            p.state = State.EATING;
            p.eatCount++;
            p.condition.signal();
            System.out.println(p + " å¼€å§‹åƒé¥­");
            return true;
        }
        return false;
    }
    
    // è·å–å‰å­
    private void takeForks(int id) throws InterruptedException {
        lock.lock();
        try {
            Philosopher p = philosophers[id];
            p.state = State.HUNGRY;
            p.hungerStartTime = systemTime.get();
            hungryQueue.offer(p);
            
            System.out.println(p + " é¥¿äº†ï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—");
            
            // æŒ‰ä¼˜å…ˆçº§å¤„ç†é¥¥é¥¿çš„å“²å­¦å®¶
            if (!test(id)) {
                p.condition.await();
            }
        } finally {
            lock.unlock();
        }
    }
    
    // æ”¾ä¸‹å‰å­
    private void putForks(int id) {
        lock.lock();
        try {
            Philosopher p = philosophers[id];
            p.state = State.THINKING;
            System.out.println(p + " æ”¾ä¸‹å‰å­");
            
            // æ¢å¤é»˜è®¤ä¼˜å…ˆçº§ï¼Œä½†ä¿æŒä¸€å®šçš„å†å²å½±å“
            p.priority = Math.min(NUM_PHILOSOPHERS, p.priority + 1);
            
            // é‡å»ºé¥¥é¥¿é˜Ÿåˆ—
            rebuildHungryQueue();
            
            // æµ‹è¯•å·¦å³é‚»å±…ï¼ŒåŒæ—¶è€ƒè™‘ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­çš„å“²å­¦å®¶
            test((id + NUM_PHILOSOPHERS - 1) % NUM_PHILOSOPHERS);
            test((id + 1) % NUM_PHILOSOPHERS);
            
            // å°è¯•å”¤é†’ä¼˜å…ˆçº§æœ€é«˜çš„é¥¥é¥¿å“²å­¦å®¶
            if (!hungryQueue.isEmpty()) {
                Philosopher next = hungryQueue.peek();
                test(next.id);
            }
        } finally {
            lock.unlock();
        }
    }
    
    // å“²å­¦å®¶è¡Œä¸º
    private void philosopherBehavior(int id) throws InterruptedException {
        while (true) {
            think(id);
            takeForks(id);
            eat(id);
            putForks(id);
        }
    }
    
    // æ€è€ƒ
    private void think(int id) throws InterruptedException {
        System.out.println(philosophers[id] + " æ­£åœ¨æ€è€ƒ");
        TimeUnit.MILLISECONDS.sleep(500 + random.nextInt(1000));
    }
    
    // åƒé¥­
    private void eat(int id) throws InterruptedException {
        System.out.println(philosophers[id] + " æ­£åœ¨åƒé¥­");
        TimeUnit.MILLISECONDS.sleep(300 + random.nextInt(700));
    }
    
    // æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
    private void displaySystemStatus() {
        lock.lock();
        try {
            System.out.println("\n===== ç³»ç»ŸçŠ¶æ€ =====");
            System.out.println("é¥¥é¥¿é˜Ÿåˆ—: " + hungryQueue);
            System.out.println("å“²å­¦å®¶çŠ¶æ€:");
            for (Philosopher p : philosophers) {
                System.out.println("  " + p);
            }
            System.out.println("====================\n");
        } finally {
            lock.unlock();
        }
    }
    
    public static void main(String[] args) {
        AdvancedDiningPhilosophers dining = new AdvancedDiningPhilosophers();
        
        // åˆ›å»ºå¹¶å¯åŠ¨çŠ¶æ€æ˜¾ç¤ºçº¿ç¨‹
        Thread statusThread = new Thread(() -> {
            while (true) {
                try {
                    TimeUnit.SECONDS.sleep(2);
                    dining.displaySystemStatus();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        });
        statusThread.setDaemon(true);
        statusThread.start();
        
        // åˆ›å»ºå¹¶å¯åŠ¨å“²å­¦å®¶çº¿ç¨‹
        for (int i = 0; i < NUM_PHILOSOPHERS; i++) {
            final int id = i;
            Thread thread = new Thread(() -> {
                try {
                    dining.philosopherBehavior(id);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
            thread.start();
        }
    }
}
```


## 7. å“²å­¦å®¶å°±é¤é—®é¢˜çš„å®é™…åº”ç”¨

### 7.1 æ•°æ®åº“äº‹åŠ¡è°ƒåº¦
åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®å…±äº«æ•°æ®å¯èƒ½å¯¼è‡´æ­»é”ï¼Œå“²å­¦å®¶å°±é¤é—®é¢˜çš„è§£å†³æ–¹æ¡ˆå¯ä»¥ç”¨äºè®¾è®¡äº‹åŠ¡è°ƒåº¦ç®—æ³•ã€‚

### 7.2 èµ„æºåˆ†é…ç³»ç»Ÿ
æ“ä½œç³»ç»Ÿä¸­çš„èµ„æºåˆ†é…å™¨éœ€è¦å¤„ç†å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„ç«äº‰ï¼Œå“²å­¦å®¶å°±é¤é—®é¢˜çš„æ€æƒ³å¯ä»¥åº”ç”¨äºèµ„æºåˆ†é…ç­–ç•¥è®¾è®¡ã€‚

### 7.3 åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åè°ƒ              
åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„èµ„æºåè°ƒå¯ä»¥å€Ÿé‰´å“²å­¦å®¶å°±é¤é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚

### 7.4 å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„é”è®¾è®¡
åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé¿å…æ­»é”å’Œé¥¥é¥¿æ˜¯é‡è¦çš„è®¾è®¡è€ƒè™‘ï¼Œå“²å­¦å®¶å°±é¤é—®é¢˜æä¾›äº†å®è´µçš„å‚è€ƒã€‚

## 8. ä»£ç ä¼˜åŒ–ä¸æ€§èƒ½è€ƒè™‘

### 8.1 å‡å°‘é”ç«äº‰
- ä½¿ç”¨ç»†ç²’åº¦é”ï¼Œåªåœ¨å¿…è¦æ—¶é”å®šèµ„æº
- å®ç°éé˜»å¡ç®—æ³•ï¼Œå‡å°‘çº¿ç¨‹é˜»å¡æ—¶é—´

### 8.2 å…¬å¹³æ€§ä¸é¥¥é¥¿é¿å…
- å®ç°ä¼˜å…ˆçº§è°ƒåº¦ï¼Œç¡®ä¿é•¿æ—¶é—´ç­‰å¾…çš„çº¿ç¨‹æœ‰æ›´é«˜ä¼˜å…ˆçº§
- ä½¿ç”¨è½®æ¢ç­–ç•¥ï¼Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰æœºä¼šè·å–èµ„æº

### 8.3 æ€§èƒ½è°ƒä¼˜
- è°ƒæ•´è¶…æ—¶æ—¶é—´å’Œé‡è¯•ç­–ç•¥
- ä½¿ç”¨å¼‚æ­¥å¤„ç†å’Œéé˜»å¡IO
- è€ƒè™‘ä½¿ç”¨æ— é”æ•°æ®ç»“æ„

## 9. æ€»ç»“

å“²å­¦å®¶å°±é¤é—®é¢˜æ˜¯ä¸€ä¸ªç»å…¸çš„å¹¶å‘æ§åˆ¶é—®é¢˜ï¼Œå®ƒæ­ç¤ºäº†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„æ­»é”ã€èµ„æºç«äº‰å’Œé¥¥é¥¿ç­‰é‡è¦æ¦‚å¿µã€‚é€šè¿‡å­¦ä¹ å’Œå®ç°ä¸åŒçš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥ç†è§£å¹¶å‘ç¼–ç¨‹ä¸­çš„æ ¸å¿ƒæŒ‘æˆ˜å’Œè§£å†³ç­–ç•¥ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼Œé€šå¸¸ä¼šç»“åˆå¤šç§æŠ€æœ¯æ¥ç¡®ä¿ç³»ç»Ÿçš„æ­£ç¡®æ€§ã€å¯é æ€§å’Œæ€§èƒ½ã€‚å“²å­¦å®¶å°±é¤é—®é¢˜çš„æ€æƒ³ä¸ä»…é€‚ç”¨äºæ“ä½œç³»ç»Ÿå’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„è®¾è®¡ï¼Œä¹Ÿä¸ºç°ä»£å¤šçº¿ç¨‹ç¼–ç¨‹æä¾›äº†å®è´µçš„æŒ‡å¯¼ã€‚