# 淘票票项目详细业务讲解

## 1. 参数加解密配置

淘票票项目采用了完善的参数加密和解密机制，确保数据在传输过程中的安全性。

### 1.1 加密配置

系统使用了多种加密算法：
- RSA签名公钥和私钥用于签名验证
- AES密钥用于数据加密
- RSA参数公钥和私钥用于参数加密

这些密钥信息存储在ChannelDataAddDto类中，包含以下关键字段：
- signPublicKey: RSA签名公钥
- signSecretKey: RSA签名私钥
- aesKey: AES私钥
- dataPublicKey: RSA参数公钥
- dataSecretKey: RSA参数私钥
- tokenSecret: Token秘钥

### 1.2 加密工具类

项目提供了多种加密工具类：
- RsaTool: 提供RSA加密和解密功能
- Aes: 提供AES加密和解密功能
- RsaSignTool: 提供RSA签名和验签功能

这些工具类封装了标准的加密算法，为系统提供统一的加解密接口。

## 2. 参数加解密过程

### 2.1 参数加密流程

1. 客户端使用RSA公钥对业务参数进行加密
2. 将加密后的参数与基础参数拼接
3. 使用RSA私钥对拼接后的参数生成签名
4. 将签名附加到请求参数中

### 2.2 参数解密流程

1. 服务端接收到请求后，首先验证签名
2. 使用RSA私钥对加密的业务参数进行解密
3. 处理解密后的业务逻辑

### 2.3 AES加密应用

在验证码等场景中使用了AES加密：
- 使用AES算法对验证码相关数据进行加密
- 通过AesUtil工具类实现加密和解密功能

## 3. Gateway处理请求的流程

网关作为系统的统一入口，负责请求的验证、路由和安全控制。

### 3.1 请求验证过滤器

RequestValidationFilter是核心的请求验证过滤器，主要功能包括：
- 参数验证
- 签名验证
- Token验证
- 请求限流

### 3.2 请求处理流程

1. 接收客户端请求
2. 解析请求参数和头部信息
3. 验证签名和Token
4. 检查是否需要进行限流
5. 路由到具体的服务
6. 处理服务响应并返回给客户端

### 3.3 上下文处理

GatewayContextHolder用于维护请求上下文：
- 存储请求相关信息
- 提供线程安全的上下文访问
- 支持在不同组件间传递请求信息

## 4. 用户注册功能详解

### 4.1 应对缓存穿透

系统通过以下方式巧妙应对缓存穿透：
- 对查询结果为空的数据也进行缓存，但设置较短的过期时间
- 使用布隆过滤器预先判断数据是否存在
- 对查询参数进行合法性校验

### 4.2 组合模式处理复杂验证

用户注册使用组合模式处理复杂的验证功能：
- 通过CompositeContainer执行多种校验逻辑
- 支持灵活添加和移除校验规则
- 将复杂的验证逻辑拆分为独立的处理单元

### 4.3 图形验证码使用

系统集成了AJ-Captcha验证码框架：
- 提供滑动验证码和点选验证码
- 支持验证码的生成、验证和管理
- 通过Redis存储验证码相关信息

## 5. 用户登录和退出流程

### 5.1 登录流程

1. 验证用户邮箱或手机号
2. 校验密码
3. 生成Token并存储到Redis
4. 返回用户信息和Token

### 5.2 退出流程

1. 验证Token有效性
2. 从Redis中删除Token
3. 更新用户登录状态
4. 返回退出成功信息

## 6. 购票人功能

购票人功能用于管理用户的观演人信息：
- 支持添加、删除、查询购票人信息
- 对身份证等敏感信息进行加密存储
- 支持多种证件类型的验证

## 7. 用户信息处理

### 7.1 信息脱敏展示

对用户的敏感信息进行脱敏处理：
- 手机号中间四位用*替代
- 身份证号部分位数用*替代
- 邮箱地址部分字符用*替代

### 7.2 信息加密存储

使用国密SM4算法对敏感信息进行加密存储：
- 用户手机号
- 用户密码
- 用户身份证号

## 8. 节目展示功能

### 8.1 主页节目列表显示

通过以下优化实现高效的节目列表显示：
- 使用Redis缓存热门节目信息
- 支持分页查询
- 对节目信息进行预加载

### 8.2 分库分表情况下的分页显示

在分库分表环境下实现节目列表分页：
- 使用ShardingSphere处理分库分表逻辑
- 通过时间范围和分页参数查询节目信息
- 对查询结果进行合并和排序

### 8.3 节目搜索功能

支持多种搜索方式：
- 关键词搜索
- 分类筛选
- 时间范围筛选
- 地点筛选

使用Elasticsearch实现高性能搜索。

### 8.4 节目详情展示

节目详情页展示完整信息：
- 节目基本信息
- 演出时间和地点
- 票档和价格信息
- 购票须知和观演须知

## 9. 座位选择流程

### 9.1 座位数据管理

- 座位信息存储在t_seat表中
- 使用缓存存储座位状态信息
- 支持座位的锁定和释放

### 9.2 座位选择流程

1. 查询节目座位信息
2. 展示座位图
3. 用户选择座位
4. 锁定选中座位
5. 生成订单

## 10. 购票验证流程

系统统一管理复杂的购票验证流程：
- 用户身份验证
- 节目信息验证
- 座位有效性验证
- 价格计算验证
- 库存数量验证

## 11. 高并发购票处理

### 11.1 应对高并发策略

- 使用分布式锁保证数据一致性
- 采用本地锁减少网络开销
- 使用Redis缓存热点数据
- 数据库层面进行分库分表

### 11.2 锁优化

对分布式锁进行优化：
- 减小锁的粒度，按节目和票档分类加锁
- 优化网络请求性能
- 使用本地锁处理部分场景

### 11.3 无锁化处理

终极杀招-无锁化处理：
- 使用Redis原子操作处理库存扣减
- 采用消息队列异步处理订单
- 利用数据库唯一索引保证数据一致性

## 12. 订单处理

### 12.1 订单生成与回滚

订单生成失败后的快速回滚机制：
- 使用事务保证数据一致性
- 异常情况下自动回滚已占用资源
- 通过补偿机制处理异常情况

### 12.2 数据初始化管理

节目服务的数据初始化统一管理：
- 节目信息初始化
- 座位信息初始化
- 票档信息初始化

### 12.3 数据一致性保障

保障节目数据在缓存与数据库间的一致性：
- 使用双写一致策略
- 通过延迟双删处理异常情况
- 定期进行数据一致性校验

## 13. 订单取消与关闭

### 13.1 订单取消处理

- 验证订单状态
- 释放占用资源
- 更新订单状态
- 处理退款流程

### 13.2 延迟订单关闭

使用Redis实现延迟队列处理订单关闭：
- 设置订单超时时间
- 自动关闭未支付订单
- 释放占用的座位资源

## 14. 支付流程

### 14.1 订单支付流程

1. 选择支付方式
2. 生成支付订单
3. 跳转到支付页面
4. 用户完成支付
5. 接收支付回调

### 14.2 支付回调处理

1. 验证回调信息
2. 更新订单状态
3. 处理库存信息
4. 发送通知消息

### 14.3 订单查询

支持查询订单详情和订单列表：
- 按订单号查询详情
- 支持分页查询订单列表
- 提供订单状态筛选

## 15. 支付渠道策略

### 15.1 支付渠道初始化

系统支持多种支付渠道：
- 支付宝支付
- 微信支付
- 银联支付

### 15.2 对账功能

支付服务中的对账功能确保交易准确性：
- 定期与第三方支付平台对账
- 发现差异及时处理
- 生成对账报告

## 16. API防刷策略

### 16.1 定制化防刷

- 接口访问频率限制
- 用户行为分析
- 异常请求识别

### 16.2 防刷策略实现

- 使用令牌桶算法进行限流
- 基于用户和IP的访问控制
- 动态调整限流策略

### 16.3 防刷数据存储策略

- 使用Redis存储访问记录
- 定期清理过期数据
- 支持分布式部署

## 17. 分库分表设计

### 17.1 用户相关表

- 用户表(t_user)
- 用户邮箱表(t_user_email)
- 购票人表(t_ticket_user)

### 17.2 节目相关表

- 节目表(t_program)
- 节目座位表(t_seat)
- 节目时间表(t_program_show_time)
- 票档表(t_ticket_category)

### 17.3 订单相关表

- 订单表(t_order)
- 购票人订单表(t_order_ticket_user)
- 支付账单表(t_pay_bill)

通过ShardingSphere实现分库分表，支持水平扩展和高并发访问。