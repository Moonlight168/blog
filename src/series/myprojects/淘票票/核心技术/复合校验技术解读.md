---
title: "å¤åˆæ ¡éªŒæŠ€æœ¯è§£è¯»"
order: 12
---

# å¤åˆæ ¡éªŒæŠ€æœ¯è§£è¯»

## 1. æ ¸å¿ƒæ¦‚å¿µ

**å¤åˆæ ¡éªŒï¼ˆComposite Validationï¼‰** æ˜¯ä¸€ç§ç»“åˆäº† **ç»„åˆæ¨¡å¼ï¼ˆComposite Patternï¼‰** å’Œ **è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibility Patternï¼‰** æ€æƒ³çš„è®¾è®¡æ–¹å¼ã€‚
å®ƒé€šè¿‡ **æ ‘å½¢ç»“æ„** ç»„ç»‡å¤šä¸ªæ ¡éªŒç»„ä»¶ï¼Œå¹¶ä»¥ **å±‚æ¬¡åŒ– + é¡ºåºåŒ–** çš„æ–¹å¼æ‰§è¡Œï¼Œä½¿å¾—å¤æ‚çš„ä¸šåŠ¡æ ¡éªŒé€»è¾‘å¾—ä»¥é«˜å†…èšã€ä½è€¦åˆåœ°ç®¡ç†å’Œæ‰©å±•ã€‚

ğŸ“Œ ç®€å•æ¥è¯´ï¼š

* **ç»„åˆæ¨¡å¼** è§£å†³çš„æ˜¯"å¦‚ä½•ç»„ç»‡æ ¡éªŒç»„ä»¶"ã€‚
* **è´£ä»»é“¾æ¨¡å¼** è§£å†³çš„æ˜¯â€œå¦‚ä½•é¡ºåºæ‰§è¡Œè¿™äº›æ ¡éªŒé€»è¾‘â€ã€‚
* æ·˜ç¥¨ç¥¨é¡¹ç›®çš„å¤åˆæ ¡éªŒï¼Œæœ¬è´¨æ˜¯ **ä¸¤è€…ç»“åˆçš„æ”¹è¿›å‹è®¾è®¡**ã€‚

---

## 2. æ ¸å¿ƒç±»åŠå…³ç³»

### 2.1 æŠ½è±¡åŸºç±»

```java
// AbstractComposite.java - å¤åˆæ ¡éªŒçš„æ ¸å¿ƒæŠ½è±¡ç±»
public abstract class AbstractComposite<T> {
    protected List<AbstractComposite<T>> list = new ArrayList<>(); // å­ç»„ä»¶åˆ—è¡¨
    
    protected abstract void execute(T param);     // æ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘
    public abstract String type();                // ç»„ä»¶ç±»å‹ï¼ˆå¦‚ user_register_checkï¼‰
    public abstract Integer executeParentOrder(); // çˆ¶çº§æ‰§è¡Œé¡ºåº
    public abstract Integer executeTier();        // æ‰§è¡Œå±‚çº§
    public abstract Integer executeOrder();       // åŒå±‚çº§æ‰§è¡Œé¡ºåº
}
```

ğŸ‘‰ ä½œç”¨ï¼šå®šä¹‰äº†ç»„ä»¶çš„åŸºæœ¬è¡Œä¸ºå’Œæ ‘å½¢ç»“æ„çš„å¿…è¦ä¿¡æ¯ã€‚

---

### 2.2 å®¹å™¨ç®¡ç†ç±»

```java
// CompositeContainer.java - å¤åˆæ ¡éªŒå®¹å™¨
public class CompositeContainer<T> {
    private final Map<String, AbstractComposite> allCompositeInterfaceMap = new HashMap<>();
    
    // æ„å»ºç»„ä»¶æ ‘ç»“æ„
    private static AbstractComposite build(Collection<AbstractComposite> components) {
        // æŒ‰å±‚çº§å’Œé¡ºåºæ„å»ºæ ‘å½¢ç»“æ„
    }
    
    // æ‰§è¡ŒæŒ‡å®šç±»å‹çš„å¤åˆæ ¡éªŒ
    public void execute(String type, T param) {
        AbstractComposite compositeInterface = Optional.ofNullable(allCompositeInterfaceMap.get(type))
            .orElseThrow(() -> new TaoPiaoPiaoFrameException(BaseCode.COMPOSITE_NOT_EXIST));
        compositeInterface.allExecute(param);
    }
}
```

ğŸ‘‰ ä½œç”¨ï¼š

* **å®¹å™¨**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ ¡éªŒç»„ä»¶
* **æ‰§è¡Œå™¨**ï¼šè´Ÿè´£æŒ‰ç…§æ ‘å½¢ç»“æ„è°ƒåº¦ç»„ä»¶æ‰§è¡Œ

---

## 3. å…·ä½“å®ç°ç±»

### 3.1 æŠ½è±¡ç”¨æˆ·æ³¨å†Œæ ¡éªŒå™¨

```java
public abstract class AbstractUserRegisterCheckHandler extends AbstractComposite<UserRegisterDto> {
    @Override
    public String type() {
        return CompositeCheckType.USER_REGISTER_CHECK.getValue(); // "user_register_check"
    }
}
```

ğŸ‘‰ ä½œç”¨ï¼šä¸ºç”¨æˆ·æ³¨å†Œåœºæ™¯ä¸‹çš„æ ¡éªŒæä¾›ç»Ÿä¸€å…¥å£ã€‚

---

### 3.2 å…·ä½“æ ¡éªŒç»„ä»¶

#### 1. éªŒè¯ç æ ¡éªŒç»„ä»¶

```java
@Component
public class UserRegisterVerifyCaptcha extends AbstractUserRegisterCheckHandler {
    @Override
    protected void execute(UserRegisterDto param) {
        // 1. å¯†ç ä¸€è‡´æ€§æ ¡éªŒ
        if (!param.getPassword().equals(param.getConfirmPassword())) {
            throw new TaoPiaoPiaoFrameException(BaseCode.TWO_PASSWORDS_DIFFERENT);
        }

        // 2. éªŒè¯ç çŠ¶æ€æ£€æŸ¥
        String verifyCaptcha = redisCache.get(
            RedisKeyBuild.createRedisKey(RedisKeyManage.VERIFY_CAPTCHA_ID, param.getCaptchaId()),
            String.class
        );

        // 3. éªŒè¯ç æœ‰æ•ˆæ€§æ ¡éªŒ
        if (VerifyCaptcha.YES.getValue().equals(verifyCaptcha)) {
            CaptchaVO captchaVO = new CaptchaVO();
            captchaVO.setCaptchaVerification(param.getCaptchaVerification());
            ResponseModel responseModel = captchaHandle.verification(captchaVO);
            if (!responseModel.isSuccess()) {
                throw new TaoPiaoPiaoFrameException(responseModel.getRepCode(), responseModel.getRepMsg());
            }
        }
    }

    @Override public Integer executeParentOrder() { return 0; } // æ ¹èŠ‚ç‚¹
    @Override public Integer executeTier() { return 1; }        // ç¬¬ä¸€å±‚çº§
    @Override public Integer executeOrder() { return 1; }       // é¡ºåº
}
```

---

#### 2. ç”¨æˆ·å­˜åœ¨æ€§æ ¡éªŒç»„ä»¶

```java
@Component
public class UserRegisterExist extends AbstractUserRegisterCheckHandler {
    @Override
    protected void execute(UserRegisterDto param) {
        // æŸ¥è¯¢æ‰‹æœºå·æ˜¯å¦å­˜åœ¨
        LambdaQueryWrapper<UserMobile> queryWrapper = Wrappers.lambdaQuery(UserMobile.class)
                .eq(UserMobile::getMobile, param.getMobile());
        UserMobile userMobile = userMobileMapper.selectOne(queryWrapper);

        if (Objects.nonNull(userMobile)) {
            throw new TaoPiaoPiaoFrameException(BaseCode.USER_EXIST);
        }
    }

    @Override public Integer executeParentOrder() { return 1; } // ä¾èµ–éªŒè¯ç æ ¡éªŒ
    @Override public Integer executeTier() { return 2; }        // ç¬¬äºŒå±‚çº§
    @Override public Integer executeOrder() { return 1; }
}
```

---

## 4. ç»„ä»¶å…³ç³»å’Œæ‰§è¡Œæµç¨‹

### 4.1 æ ‘å½¢ç»“æ„å…³ç³»

```
UserRegisterCheckHandler (æ ¹èŠ‚ç‚¹, Tier=1)
â”œâ”€â”€ UserRegisterVerifyCaptcha (Tier=2, Order=1)
â””â”€â”€ UserRegisterExist (Tier=2, Order=2)
    â””â”€â”€ UserRegisterFrequency (Tier=3, Order=1)
```

### 4.2 æ‰§è¡Œæµç¨‹

```java
// å±‚æ¬¡éå†æ‰§è¡Œæ‰€æœ‰ç»„ä»¶
public void allExecute(T param) {
    Queue<AbstractComposite<T>> queue = new LinkedList<>();
    queue.add(this); // æ·»åŠ æ ¹èŠ‚ç‚¹

    while (!queue.isEmpty()) {
        int levelSize = queue.size();

        for (int i = 0; i < levelSize; i++) {
            AbstractComposite<T> current = queue.poll();
            current.execute(param);        // æ‰§è¡Œå½“å‰é€»è¾‘
            queue.addAll(current.list);    // æ·»åŠ å­èŠ‚ç‚¹
        }
    }
}
```


## 5. ä½¿ç”¨æ–¹å¼

### 5.1 æœåŠ¡å±‚è°ƒç”¨

```java
@Service
public class UserService {
    @Autowired
    private CompositeContainer compositeContainer;

    @Transactional(rollbackFor = Exception.class)
    public Boolean register(UserRegisterDto userRegisterDto) {
        // æ‰§è¡Œå¤åˆæ ¡éªŒ
        compositeContainer.execute(CompositeCheckType.USER_REGISTER_CHECK.getValue(), userRegisterDto);

        // æ ¡éªŒé€šè¿‡åä¿å­˜ç”¨æˆ·
        User user = new User();
        BeanUtils.copyProperties(userRegisterDto, user);
        user.setId(uidGenerator.getUid());
        userMapper.insert(user);

        return true;
    }
}
```

### 5.2 åˆå§‹åŒ–å®¹å™¨

```java
public class CompositeInit extends AbstractApplicationStartEventListenerHandler {
    private final CompositeContainer compositeContainer;

    @Override
    public void executeInit(ConfigurableApplicationContext context) {
        compositeContainer.init(context); // å¯åŠ¨æ—¶æ„å»ºç»„ä»¶æ ‘
    }
}
```


## 6. ç›¸å…³æ¦‚å¿µ

* **ç»„åˆæ¨¡å¼ï¼ˆComposite Patternï¼‰**

  * å®šä¹‰ï¼šå°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œéƒ¨åˆ†-æ•´ä½“â€å±‚æ¬¡ã€‚
  * åº”ç”¨ï¼šä¸åŒæ ¡éªŒç»„ä»¶è¢«ç»„åˆæˆä¸€æ£µæ ¡éªŒæ ‘ã€‚

* **è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibility Patternï¼‰**

  * å®šä¹‰ï¼šä½¿å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œä»è€Œé¿å…è¯·æ±‚ä¸å¤„ç†è€…çš„è€¦åˆã€‚
  * åº”ç”¨ï¼šåœ¨æ ‘ç»“æ„ä¸­ï¼Œä¸åŒå±‚çº§çš„æ ¡éªŒå™¨æŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚

* **åˆ†å±‚æ ¡éªŒ**

  * æ¦‚å¿µï¼šå°†å¤æ‚é€»è¾‘æ‹†è§£ä¸ºå¤šå±‚ï¼Œæ¯å±‚åªåšæœ¬å±‚æ ¡éªŒã€‚
  * ä¼˜åŠ¿ï¼šé€»è¾‘æ¸…æ™°ï¼Œå¯ç»´æŠ¤æ€§å¼ºã€‚

* **åŠ¨æ€æ„å»º**

  * æ¦‚å¿µï¼šè¿è¡Œæ—¶æ ¹æ® `executeTier`ã€`executeOrder`ã€`executeParentOrder` ä¿¡æ¯åŠ¨æ€ç»„è£…æ ‘ã€‚
  * ä¼˜åŠ¿ï¼šæ— éœ€ç¡¬ç¼–ç ä¾èµ–ï¼Œæ–°å¢æ ¡éªŒåªéœ€å®ç°ç±»ã€‚


## 7. è®¾è®¡ä¼˜åŠ¿

1. **é«˜å†…èšä½è€¦åˆ**ï¼šå„ä¸ªæ ¡éªŒç»„ä»¶èŒè´£å•ä¸€ï¼Œå½¼æ­¤ç‹¬ç«‹ã€‚
2. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢æ ¡éªŒä»…éœ€æ–°å¢ä¸€ä¸ªç»„ä»¶ç±»å³å¯ã€‚
3. **çµæ´»é…ç½®**ï¼šé€šè¿‡å±‚çº§ä¸é¡ºåºæ§åˆ¶æ‰§è¡Œé€»è¾‘ã€‚
4. **å±‚æ¬¡æ¸…æ™°**ï¼šæ ‘å½¢ç»“æ„ä½¿å¤æ‚é€»è¾‘åˆ†å±‚æ˜ç¡®ã€‚
5. **å¯å¤ç”¨æ€§**ï¼šåŒä¸€æ ¡éªŒç»„ä»¶å¯ç”¨äºä¸åŒä¸šåŠ¡åœºæ™¯ã€‚

## ç›¸å…³ç–‘é—®

## ä¸ºä»€ä¹ˆCompositeContainerèƒ½è·å–AbstractCompositeç±»å‹çš„beanå®ä¾‹

è¿™æ˜¯å› ä¸ºSpringæ¡†æ¶çš„**ç±»å‹åŒ¹é…æœºåˆ¶**å’Œ**ä¾èµ–æ³¨å…¥åŸç†**ã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šï¼š

### 1. Springçš„Beanç±»å‹åŒ¹é…æœºåˆ¶

```java
// Springæ¡†æ¶æ ¸å¿ƒæ–¹æ³•ï¼šgetBeansOfType()
Map<String, AbstractComposite> compositeInterfaceMap = 
    applicationEvent.getBeansOfType(AbstractComposite.class);
```


è¿™ä¸ªæ–¹æ³•èƒ½å¤Ÿè·å–åˆ°æ‰€æœ‰**ç±»å‹ä¸ºAbstractCompositeæˆ–å…¶å­ç±»**çš„Beanå®ä¾‹ï¼ŒåŸå› å¦‚ä¸‹ï¼š

#### ç»§æ‰¿å…³ç³»é“¾ï¼š
```
AbstractComposite<T> (æŠ½è±¡ç±»)
    â†‘
AbstractUserRegisterCheckHandler (ç”¨æˆ·æ³¨å†Œæ ¡éªŒæŠ½è±¡ç±»)
    â†‘
UserRegisterVerifyCaptcha (å…·ä½“æ ¡éªŒç»„ä»¶)
UserRegisterExist (å…·ä½“æ ¡éªŒç»„ä»¶)
UserRegisterFrequency (å…·ä½“æ ¡éªŒç»„ä»¶)
    â†‘
(ä»¥åŠå…¶ä»–æ‰€æœ‰ç»§æ‰¿è‡ªAbstractCompositeçš„ç»„ä»¶)
```


### 2. Spring Beanæ³¨å†Œæœºåˆ¶

#### ç»„ä»¶è‡ªåŠ¨æ³¨å†Œï¼š
```java
// UserRegisterVerifyCaptcha.java
@Component  // è¿™ä¸ªæ³¨è§£ä½¿ç±»æˆä¸ºSpring Bean
public class UserRegisterVerifyCaptcha extends AbstractUserRegisterCheckHandler {
    // ...
}

// UserRegisterExist.java
@Component  // è‡ªåŠ¨æ³¨å†Œä¸ºSpring Bean
public class UserRegisterExist extends AbstractUserRegisterCheckHandler {
    // ...
}
```


å½“Springå®¹å™¨å¯åŠ¨æ—¶ï¼š
1. æ‰«ææ‰€æœ‰å¸¦æœ‰[@Component]æ³¨è§£çš„ç±»
2. åˆ›å»ºè¿™äº›ç±»çš„å®ä¾‹å¹¶æ³¨å†Œåˆ°IoCå®¹å™¨ä¸­
3. è®°å½•æ¯ä¸ªBeançš„å®é™…ç±»å‹å’Œå£°æ˜ç±»å‹

### 3. å¤šæ€æ€§åŸç†

#### Javaå¤šæ€æ€§ï¼š
```java
// è™½ç„¶å®é™…åˆ›å»ºçš„æ˜¯å…·ä½“ç±»å®ä¾‹ï¼Œä½†å®ƒä»¬éƒ½æ˜¯AbstractCompositeçš„å­ç±»
UserRegisterVerifyCaptcha captchaChecker = new UserRegisterVerifyCaptcha();
AbstractComposite composite = captchaChecker;  // å¤šæ€èµ‹å€¼

// Springå®¹å™¨ä¸­å­˜å‚¨çš„æ˜¯å®é™…ç±»å‹ï¼Œä½†å¯ä»¥é€šè¿‡çˆ¶ç±»å‹å¼•ç”¨è·å–
```


### 4. getBeansOfType()å·¥ä½œåŸç†

```java
// Springå†…éƒ¨å®ç°é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
public <T> Map<String, T> getBeansOfType(Class<T> type) {
    Map<String, T> result = new HashMap<>();
    
    // éå†æ‰€æœ‰å·²æ³¨å†Œçš„Bean
    for (String beanName : beanDefinitionNames) {
        Class<?> beanClass = getBeanClass(beanName);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æŒ‡å®šç±»å‹çš„å­ç±»æˆ–å®ç°ç±»
        if (type.isAssignableFrom(beanClass)) {
            // å¦‚æœæ˜¯ï¼Œåˆ™æ·»åŠ åˆ°ç»“æœä¸­
            result.put(beanName, (T) getBean(beanName));
        }
    }
    
    return result;
}
```


### 5. å®é™…æ‰§è¡Œè¿‡ç¨‹

#### æ­¥éª¤1ï¼šSpringå®¹å™¨å¯åŠ¨
```java
// Springæ‰«æå¹¶åˆ›å»ºä»¥ä¸‹Beanå®ä¾‹ï¼š
// - UserRegisterVerifyCaptcha (å®é™…ç±»å‹)
// - UserRegisterExist (å®é™…ç±»å‹)  
// - UserRegisterFrequency (å®é™…ç±»å‹)
// è¿™äº›éƒ½ç»§æ‰¿è‡ª AbstractComposite
```


#### æ­¥éª¤2ï¼šç±»å‹åŒ¹é…
```java
// å½“è°ƒç”¨ getBeansOfType(AbstractComposite.class) æ—¶ï¼š
// Springæ£€æŸ¥æ¯ä¸ªBeanæ˜¯å¦æ˜¯AbstractCompositeçš„å­ç±»
// UserRegisterVerifyCaptcha instanceof AbstractComposite ? true
// UserRegisterExist instanceof AbstractComposite ? true
// UserRegisterFrequency instanceof AbstractComposite ? true
```


#### æ­¥éª¤3ï¼šè¿”å›åŒ¹é…ç»“æœ
```java
// æœ€ç»ˆè¿”å›åŒ…å«æ‰€æœ‰æ ¡éªŒç»„ä»¶çš„Mapï¼š
Map<String, AbstractComposite> result = {
    "userRegisterVerifyCaptcha": UserRegisterVerifyCaptchaå®ä¾‹,
    "userRegisterExist": UserRegisterExistå®ä¾‹,
    "userRegisterFrequency": UserRegisterFrequencyå®ä¾‹
}
```


### 6. ä»£ç ç¤ºä¾‹éªŒè¯

``java
// éªŒè¯å¤šæ€æ€§
@Test
public void testPolymorphism() {
    // å®é™…åˆ›å»ºå…·ä½“ç±»å®ä¾‹
    UserRegisterVerifyCaptcha concrete = new UserRegisterVerifyCaptcha();
    
    // é€šè¿‡çˆ¶ç±»å¼•ç”¨
    AbstractComposite abstractRef = concrete;
    
    // ç±»å‹æ£€æŸ¥
    assertTrue(abstractRef instanceof AbstractComposite);  // true
    assertTrue(abstractRef instanceof AbstractUserRegisterCheckHandler);  // true
    assertTrue(abstractRef instanceof UserRegisterVerifyCaptcha);  // true
}
```


### æ€»ç»“

**CompositeContainerèƒ½è·å–AbstractCompositeç±»å‹Beançš„æ ¹æœ¬åŸå› **ï¼š

1. **ç»§æ‰¿å…³ç³»**ï¼šæ‰€æœ‰å…·ä½“çš„æ ¡éªŒç»„ä»¶éƒ½ç»§æ‰¿è‡ª[AbstractComposite]
2. **Springæœºåˆ¶**ï¼š`getBeansOfType()`åˆ©ç”¨Javaåå°„å’Œç±»å‹æ£€æŸ¥æœºåˆ¶
3. **å¤šæ€æ”¯æŒ**ï¼šJavaçš„å¤šæ€æ€§å…è®¸çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å®ä¾‹
4. **è‡ªåŠ¨æ³¨å†Œ**ï¼š[@Component]æ³¨è§£ä½¿æ ¡éªŒç»„ä»¶è‡ªåŠ¨æˆä¸ºSpring Bean

è¿™ç§è®¾è®¡å……åˆ†åˆ©ç”¨äº†é¢å‘å¯¹è±¡çš„ç»§æ‰¿å’Œå¤šæ€ç‰¹æ€§ï¼Œä»¥åŠSpringæ¡†æ¶çš„ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œå®ç°äº†çµæ´»çš„ç»„ä»¶ç®¡ç†å’Œç»„åˆæ¨¡å¼.